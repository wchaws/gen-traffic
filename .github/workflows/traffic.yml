name: gen-traffic

on:
  schedule:
    - cron: "*/1 * * * *" 

jobs:
  gen-traffic:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate traffic
        env:
          HOST: ${{ secrets.HOST }}
        run: |
          MAX_CONCURRENT_REQUESTS=20
          MAX_FAILED_REQUESTS=3
          urls=$(cat urls.txt)
          url_count=$(wc -l <<< "$urls")

          current_url=1
          failed_requests=0

          while [ $current_url -le $url_count ]; do
            url=$(sed -n "${current_url}p" <<< "$urls")
            echo "Making request to ${url}"
            response=$(curl -s -o /dev/null -w "%{http_code}" "$url")

            if [ "$response" != "200" ]; then
              echo "âŒ à¸„à¸³à¸‚à¸­à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§à¸”à¹‰à¸§à¸¢à¸ªà¸–à¸²à¸™à¸° $response ðŸ˜ž"
              failed_requests=$((failed_requests+1))

              if [ $failed_requests -ge $MAX_FAILED_REQUESTS ]; then
                echo "âš ï¸ à¹€à¸à¸´à¸™à¸‚à¸µà¸”à¸ˆà¸³à¸à¸±à¸”à¸„à¸³à¸‚à¸­à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§ à¸à¸³à¸¥à¸±à¸‡à¹€à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸›à¸—à¸µà¹ˆà¸¥à¸´à¸‡à¸à¹Œà¸–à¸±à¸”à¹„à¸›... â­ï¸"
                current_url=$((current_url+1))
                failed_requests=0

                if [ $current_url -gt $url_count ]; then
                  echo "âš ï¸ à¹€à¸„à¸¢à¸–à¸¶à¸‡à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”à¸‚à¸­à¸‡à¸£à¸²à¸¢à¸à¸²à¸£à¸¥à¸´à¸‡à¸à¹Œà¹à¸¥à¹‰à¸§ à¹„à¸¡à¹ˆà¸¡à¸µà¸¥à¸´à¸‡à¸à¹Œà¹€à¸žà¸´à¹ˆà¸¡à¸—à¸µà¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰à¹à¸¥à¹‰à¸§ âŒ"
                  current_url=1
                fi

                sleep 2
                continue
              fi
            fi

            current_url=$((current_url+1))

            echo "â³ à¸à¸³à¸¥à¸±à¸‡à¸£à¸­ 2 à¸§à¸´à¸™à¸²à¸—à¸µà¸à¹ˆà¸­à¸™à¸—à¸µà¹ˆà¸ˆà¸°à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸‚à¸­à¹ƒà¸«à¸¡à¹ˆ... âŒ›"
            sleep 2
          done
